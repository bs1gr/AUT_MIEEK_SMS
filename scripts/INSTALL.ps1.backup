# ============================================================================
#   Student Management System - Installation Script (PowerShell)
# ============================================================================

# Change to project root directory (parent of scripts folder)
$projectRoot = Split-Path -Parent $PSScriptRoot
Set-Location $projectRoot

Write-Host ""
Write-Host "====================================================================" -ForegroundColor Cyan
Write-Host "  Student Management System - Automated Installation" -ForegroundColor Cyan
Write-Host "====================================================================" -ForegroundColor Cyan
Write-Host ""
Write-Host "This will install all dependencies and set up the application." -ForegroundColor White
Write-Host ""
Read-Host "Press Enter to continue"

# Progress setup
$progressId = 1
function Set-Progress {
    param(
        [int]$Percent,
        [string]$Status
    )
    Write-Progress -Id $progressId -Activity "Installing Student Management System" -Status $Status -PercentComplete $Percent
}
Set-Progress -Percent 0 -Status "Starting installation..."

# Check Python
Write-Host ""
Write-Host "[1/7] Checking Python installation..." -ForegroundColor Yellow
Set-Progress -Percent 5 -Status "Checking Python installation..."
try {
    $pythonVersion = python --version 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  OK $pythonVersion" -ForegroundColor Green
    } else {
        throw "Python not found"
    }
} catch {
    Write-Host "  X ERROR: Python is not installed or not in PATH!" -ForegroundColor Red
    Write-Host "  Please install Python 3.10 or higher from: https://www.python.org/downloads/" -ForegroundColor Yellow
    Read-Host "Press Enter to exit"
    exit 1
}

# Check for C++ Build Tools / Rust (required for cryptography and other Python packages)
Write-Host ""
Write-Host "[2/7] Checking C++ Build Tools..." -ForegroundColor Yellow
Set-Progress -Percent 15 -Status "Checking build tools (MSVC/Rust)..."
$buildToolsFound = $false

# Method 1: Check for Visual Studio Build Tools via vswhere
$vsWherePath = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
if (Test-Path $vsWherePath) {
    $vsInstalls = & $vsWherePath -products * -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath 2>&1
    if ($vsInstalls -and $LASTEXITCODE -eq 0) {
        $buildToolsFound = $true
        Write-Host "  OK Visual Studio C++ Build Tools detected" -ForegroundColor Green
    }
}

# Method 2: Check for Rust (alternative to MSVC)
if (-not $buildToolsFound) {
    try {
        $rustcVersion = rustc --version 2>&1
        if ($LASTEXITCODE -eq 0) {
            $buildToolsFound = $true
            Write-Host "  OK Rust toolchain detected: $rustcVersion" -ForegroundColor Green
        }
    } catch {
        # Rust not found
    }
}

# Method 3: Check common cl.exe locations (MSVC compiler)
if (-not $buildToolsFound) {
    $clPaths = @(
        "${env:ProgramFiles}\Microsoft Visual Studio\2022\BuildTools\VC\Tools\MSVC\*\bin\Hostx64\x64\cl.exe",
        "${env:ProgramFiles}\Microsoft Visual Studio\2022\Community\VC\Tools\MSVC\*\bin\Hostx64\x64\cl.exe",
        "${env:ProgramFiles(x86)}\Microsoft Visual Studio\2019\BuildTools\VC\Tools\MSVC\*\bin\Hostx64\x64\cl.exe"
    )
    
    foreach ($path in $clPaths) {
        if (Test-Path $path) {
            $buildToolsFound = $true
            Write-Host "  OK Microsoft Visual C++ compiler detected" -ForegroundColor Green
            break
        }
    }
}

if (-not $buildToolsFound) {
    Write-Host "  ! WARNING: C++ Build Tools not detected" -ForegroundColor Yellow
    Write-Host ""
    Write-Host "  Some Python packages (like cryptography) require C++ compilation." -ForegroundColor Yellow
    Write-Host "  If installation fails later, you'll need one of these:" -ForegroundColor Yellow
    Write-Host ""
    Write-Host "  OPTION 1 (Recommended): Microsoft C++ Build Tools" -ForegroundColor White
    Write-Host "    1. Download: https://visualstudio.microsoft.com/visual-cpp-build-tools/" -ForegroundColor Gray
    Write-Host "    2. Install 'Desktop development with C++' workload" -ForegroundColor Gray
    Write-Host "    3. Restart terminal and run installer again" -ForegroundColor Gray
    Write-Host ""
    Write-Host "  OPTION 2 (Alternative): Rust Toolchain" -ForegroundColor White
    Write-Host "    1. Download: https://rustup.rs/" -ForegroundColor Gray
    Write-Host "    2. Install using default settings" -ForegroundColor Gray
    Write-Host "    3. Restart terminal and run installer again" -ForegroundColor Gray
    Write-Host ""
    
    $continue = Read-Host "  Continue anyway? (Y/N - if unsure, try Y first)"
    if ($continue -notmatch '^(Y|y)$') {
        Write-Host ""
        Write-Host "  Installation cancelled. Install build tools and try again." -ForegroundColor Yellow
        Read-Host "Press Enter to exit"
        exit 1
    }
    Write-Host "  Proceeding... (install may fail if build tools are actually needed)" -ForegroundColor Yellow
}

# Check Node.js version (critical for Vite 5.x)
Write-Host ""
Write-Host "[3/7] Checking Node.js installation..." -ForegroundColor Yellow
Set-Progress -Percent 25 -Status "Checking Node.js and npm..."
$nodeInstalled = $false
$nodeVersionValid = $false

try {
    $nodeVersionOutput = node --version 2>&1
    if ($LASTEXITCODE -eq 0) {
        $nodeInstalled = $true
        Write-Host "  Found Node.js: $nodeVersionOutput" -ForegroundColor Cyan
        
        # Extract version number (remove 'v' prefix)
        $versionString = $nodeVersionOutput.ToString().TrimStart('v')
        $versionParts = $versionString -split '\.'
        $majorVersion = [int]$versionParts[0]
        
        # Vite 5.x requires Node.js 18+
        if ($majorVersion -ge 18) {
            $nodeVersionValid = $true
            Write-Host "  OK Node.js version is compatible (18+)" -ForegroundColor Green
            
            # Check npm
            $npmVersion = npm --version 2>&1
            if ($LASTEXITCODE -eq 0) {
                Write-Host "  OK npm: v$npmVersion" -ForegroundColor Green
            } else {
                Write-Host "  X ERROR: npm not found!" -ForegroundColor Red
                Read-Host "Press Enter to exit"
                exit 1
            }
        } else {
            Write-Host "  X Node.js version is TOO OLD!" -ForegroundColor Red
            Write-Host ""
            Write-Host "  CRITICAL ISSUE:" -ForegroundColor Red
            Write-Host "  - Your Node.js version: $nodeVersionOutput" -ForegroundColor Yellow
            Write-Host "  - Required version: v18.0.0 or higher" -ForegroundColor Yellow
            Write-Host "  - Reason: Vite 5.x requires Node.js 18+" -ForegroundColor Yellow
            Write-Host ""
            Write-Host "  This will cause the error:" -ForegroundColor Red
            Write-Host "    'TypeError: crypto.getRandomValues is not a function'" -ForegroundColor Gray
            Write-Host ""
            Write-Host "  FIX THIS NOW:" -ForegroundColor Red
            Write-Host "  1. Visit: https://nodejs.org/" -ForegroundColor White
            Write-Host "  2. Download Node.js LTS (v18 or v20 recommended)" -ForegroundColor White
            Write-Host "  3. Install and restart your terminal" -ForegroundColor White
            Write-Host "  4. Run this installer again" -ForegroundColor White
            Write-Host ""
            Read-Host "Press Enter to exit"
            exit 1
        }
    } else {
        Write-Host "  X Node.js not found!" -ForegroundColor Red
    }
} catch {
    Write-Host "  X Node.js not found!" -ForegroundColor Red
}

if (-not $nodeInstalled) {
    Write-Host ""
    Write-Host "  ACTION REQUIRED:" -ForegroundColor Red
    Write-Host "  Node.js is not installed on this system." -ForegroundColor Yellow
    Write-Host ""
    Write-Host "  Installation steps:" -ForegroundColor Yellow
    Write-Host "  1. Visit: https://nodejs.org/" -ForegroundColor White
    Write-Host "  2. Download Node.js LTS (v18 or v20 recommended)" -ForegroundColor White
    Write-Host "  3. Run the installer" -ForegroundColor White
    Write-Host "  4. Restart your terminal/command prompt" -ForegroundColor White
    Write-Host "  5. Run this installer again" -ForegroundColor White
    Write-Host ""
    Read-Host "Press Enter to exit"
    exit 1
}

# Create Python virtual environment
Write-Host ""
Write-Host "[4/7] Creating Python virtual environment..." -ForegroundColor Yellow
Set-Progress -Percent 45 -Status "Creating Python virtual environment..."
Set-Location backend

if (Test-Path "venv") {
    Write-Host "  OK Virtual environment already exists." -ForegroundColor Green
} else {
    python -m venv venv
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  OK Virtual environment created." -ForegroundColor Green
    } else {
        Write-Host "  X Failed to create virtual environment!" -ForegroundColor Red
        Set-Location ..
        Read-Host "Press Enter to exit"
        exit 1
    }
}

# Install Python dependencies
Write-Host ""
Write-Host "[5/7] Installing Python dependencies..." -ForegroundColor Yellow
Set-Progress -Percent 55 -Status "Installing Python dependencies (pip)..."
& ".\venv\Scripts\Activate.ps1"
pip install --upgrade pip --quiet

Write-Host "  Installing packages (this may take a few minutes)..." -ForegroundColor Gray
Write-Host "  Note: Some packages (cryptography) may require C++ compilation" -ForegroundColor Gray
pip install -r requirements.txt

if ($LASTEXITCODE -eq 0) {
    Write-Host "  OK Python dependencies installed successfully!" -ForegroundColor Green
    Set-Progress -Percent 70 -Status "Python dependencies installed"
} else {
    Write-Host "  X ERROR: Failed to install Python dependencies!" -ForegroundColor Red
    Write-Host ""
    Write-Host "  Common causes:" -ForegroundColor Yellow
    Write-Host "  1. Missing C++ Build Tools (required for cryptography package)" -ForegroundColor White
    Write-Host "  2. Network connection issues" -ForegroundColor White
    Write-Host ""
    Write-Host "  If you see 'error: Microsoft Visual C++ 14.0 or greater is required':" -ForegroundColor Yellow
    Write-Host "  - Install Visual C++ Build Tools from:" -ForegroundColor White
    Write-Host "    https://visualstudio.microsoft.com/visual-cpp-build-tools/" -ForegroundColor Gray
    Write-Host "  - OR install Rust from: https://rustup.rs/" -ForegroundColor White
    Write-Host ""
    Set-Location ..
    Read-Host "Press Enter to exit"
    exit 1
}

# Install frontend dependencies
Write-Host ""
Write-Host "[6/7] Installing frontend dependencies..." -ForegroundColor Yellow
Set-Progress -Percent 80 -Status "Installing frontend dependencies (npm)..."
Set-Location ..\frontend

# Verify we're in the right directory
if (-not (Test-Path "package.json")) {
    Write-Host "  X ERROR: package.json not found in frontend directory!" -ForegroundColor Red
    Set-Location ..
    Read-Host "Press Enter to exit"
    exit 1
}

# Clean install for fresh setup
Write-Host "  Running npm install (this may take a few minutes)..." -ForegroundColor Gray
npm install --verbose

if ($LASTEXITCODE -eq 0) {
    Write-Host "  OK Frontend dependencies installed successfully!" -ForegroundColor Green
    Set-Progress -Percent 90 -Status "Frontend dependencies installed"
    
    # Verify critical dependencies
    Write-Host "  Verifying installation..." -ForegroundColor Gray
    if (Test-Path "node_modules") {
        $moduleCount = (Get-ChildItem "node_modules" -Directory).Count
        Write-Host "  OK $moduleCount packages installed" -ForegroundColor Green
    } else {
        Write-Host "  X WARNING: node_modules folder not created!" -ForegroundColor Yellow
    }
} else {
    Write-Host "  X ERROR: Failed to install frontend dependencies!" -ForegroundColor Red
    Write-Host ""
    Write-Host "  Troubleshooting steps:" -ForegroundColor Yellow
    Write-Host "  1. Check your internet connection" -ForegroundColor White
    Write-Host "  2. Try: npm cache clean --force" -ForegroundColor White
    Write-Host "  3. Delete node_modules folder and try again" -ForegroundColor White
    Write-Host "  4. Check npm version: npm --version" -ForegroundColor White
    Write-Host ""
    # Offer to run diagnostic tool now
    $runDiag = Read-Host "Would you like to run the frontend diagnostic tool now? (Y/N)"
    if ($runDiag -match '^(Y|y)$') {
        Set-Location ..
        & ".\scripts\DIAGNOSE_FRONTEND.ps1"
        Write-Host ""
    } else {
        Set-Location ..
    }
    Read-Host "Press Enter to exit"
    exit 1
}

# Create necessary directories
Write-Host ""
Write-Host "[7/7] Creating necessary directories..." -ForegroundColor Yellow
Set-Progress -Percent 95 -Status "Creating directories..."
Set-Location ..

$directories = @("backups", "logs", "backend\logs")
foreach ($dir in $directories) {
    if (-not (Test-Path $dir)) {
        New-Item -ItemType Directory -Path $dir -Force | Out-Null
    }
}
Write-Host "  OK Directories created." -ForegroundColor Green
Set-Progress -Percent 100 -Status "Installation complete"

# Success
Write-Host ""
Write-Host "====================================================================" -ForegroundColor Cyan
Write-Host "  Installation Complete!" -ForegroundColor Green
Write-Host "====================================================================" -ForegroundColor Cyan
Write-Host ""
Write-Host "Next steps:" -ForegroundColor Yellow
Write-Host "  1. Run LAUNCHER.bat (or use RUN.bat)" -ForegroundColor White
Write-Host "  2. Open http://localhost:5173 in your browser" -ForegroundColor White
Write-Host "  3. If frontend doesn't start, run: .\\scripts\\DIAGNOSE_FRONTEND.bat" -ForegroundColor White
Write-Host "  4. Refer to INSTALL_GUIDE.md for detailed documentation" -ForegroundColor White
Write-Host ""
Write-Host "====================================================================" -ForegroundColor Cyan
Write-Host ""

Read-Host "Press Enter to exit"
