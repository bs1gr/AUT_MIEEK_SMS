name: CI Failure Monitor - Debug (manual)

on:
  workflow_dispatch:

jobs:
  debug-create-issue:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
      - name: Run monitor debug (create issue + upload response)
        env:
          TOKEN: ${{ secrets.CI_MONITOR_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          DIAG=monitor_issue_response.json
          echo '{}' > "$DIAG"
          if [ -z "${TOKEN:-}" ]; then
            echo "CI_MONITOR_TOKEN not set; skipping issue creation." | tee -a "$DIAG"
            exit 0
          fi
          title="DEBUG CI failure: manual run"
          body="This is a debug-run for the CI failure monitor.\n\nRepo: ${REPO}\nTime: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          payload=$(jq -n --arg title "$title" --arg body "$body" '{title:$title, body:$body, labels:["ci-failure","monitor-debug"]}')
          echo "Creating issue using PAT (debug)..."
          resp=$(curl -s -H "Authorization: token $TOKEN" -X POST -d "$payload" "https://api.github.com/repos/${REPO}/issues") || true
          echo "$resp" > "$DIAG"

      - name: Upload monitor debug artifact
        uses: actions/upload-artifact@v4
        with:
          name: monitor-issue-response
          path: monitor_issue_response.json
