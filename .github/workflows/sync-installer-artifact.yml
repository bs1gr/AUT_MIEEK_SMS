name: Sync Installer Artifact to Repo

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Branch to commit the synced installer artifact to'
        required: true
        default: 'main'
      version:
        description: 'Version to sync (e.g., 1.18.4). Leave empty to use VERSION file.'
        required: false
      skip_codesign:
        description: 'Skip code signing during build (true/false)'
        required: true
        default: 'false'

permissions:
  contents: write

concurrency:
  group: sync-installer-artifact-${{ github.event.inputs.target_branch || github.ref_name }}
  cancel-in-progress: true

jobs:
  sync-installer:
    runs-on: windows-latest
    name: Build and Sync Installer into Repository

    steps:
      - name: Checkout target branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.inputs.target_branch }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Install Inno Setup 6
        shell: pwsh
        run: |
          choco install innosetup -y --no-progress
          $paths = @(
            "C:\\Program Files (x86)\\Inno Setup 6",
            "C:\\Program Files\\Inno Setup 6",
            "$env:LOCALAPPDATA\Programs\Inno Setup 6"
          )
          foreach ($p in $paths) {
            if (Test-Path $p) {
              Write-Host "Inno Setup installed at $p"
              $env:PATH += ";$p"
              break
            }
          }

      - name: Resolve target version
        id: resolve
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $inputVersion = "${{ github.event.inputs.version }}".Trim()
          if ([string]::IsNullOrWhiteSpace($inputVersion)) {
            if (-not (Test-Path VERSION)) {
              Write-Error 'VERSION file not found and no version input provided.'
              exit 1
            }
            $inputVersion = (Get-Content VERSION -Raw).Trim()
          }

          if ($inputVersion -notmatch '^\d+\.\d+\.\d+$') {
            Write-Error "Invalid version '$inputVersion'. Expected format: MAJOR.MINOR.PATCH (e.g., 1.18.4)"
            exit 1
          }

          "version=$inputVersion" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "dist_path=dist/SMS_Installer_$inputVersion.exe" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "repo_path=installer/SMS_Installer_$inputVersion.exe" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

          Write-Host "Resolved version: $inputVersion"

      - name: Clean dist
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          if (Test-Path dist) {
            Get-ChildItem dist -File -ErrorAction SilentlyContinue | Remove-Item -Force -ErrorAction SilentlyContinue
          }
          New-Item -ItemType Directory -Path dist -Force | Out-Null

      - name: Validate signing prerequisites
        if: github.event.inputs.skip_codesign != 'true'
        shell: pwsh
        env:
          CODESIGN_PFX_BASE64: ${{ secrets.CODESIGN_PFX_BASE64 }}
          CODESIGN_PFX_PASSWORD: ${{ secrets.CODESIGN_PFX_PASSWORD }}
        run: |
          $ErrorActionPreference = 'Stop'

          if (-not $env:CODESIGN_PFX_BASE64 -or -not $env:CODESIGN_PFX_PASSWORD) {
            Write-Error "Code signing requested (skip_codesign=false), but CODESIGN_PFX_BASE64/CODESIGN_PFX_PASSWORD secrets are missing."
            Write-Error "Either configure secrets or re-run with skip_codesign=true."
            exit 1
          }

      - name: Import code signing certificate
        if: github.event.inputs.skip_codesign != 'true'
        shell: pwsh
        env:
          CODESIGN_PFX_BASE64: ${{ secrets.CODESIGN_PFX_BASE64 }}
          CODESIGN_PFX_PASSWORD: ${{ secrets.CODESIGN_PFX_PASSWORD }}
        run: |
          $ErrorActionPreference = 'Stop'

          $pfxPath = Join-Path $env:RUNNER_TEMP "sms_codesign_sync.pfx"
          [IO.File]::WriteAllBytes($pfxPath, [Convert]::FromBase64String($env:CODESIGN_PFX_BASE64))

          $securePassword = ConvertTo-SecureString $env:CODESIGN_PFX_PASSWORD -AsPlainText -Force
          Import-PfxCertificate -FilePath $pfxPath -CertStoreLocation "Cert:\CurrentUser\My" -Password $securePassword | Out-Null

          Write-Host "Code signing certificate imported to CurrentUser store."

      - name: Build installer
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $skipCodesignInput = "${{ github.event.inputs.skip_codesign }}".ToLowerInvariant()

          $buildArgs = @('-Action', 'build', '-AutoFix', '-Verbose', '-Version', '${{ steps.resolve.outputs.version }}')
          if ($skipCodesignInput -eq 'true') {
            $buildArgs += '-SkipCodeSign'
          }

          Write-Host "Running INSTALLER_BUILDER.ps1 with args: $($buildArgs -join ' ')"
          & .\INSTALLER_BUILDER.ps1 @buildArgs

          if ($LASTEXITCODE -ne 0) {
            Write-Error 'Installer build failed.'
            exit 1
          }

      - name: Verify built installer exists
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $distPath = "${{ steps.resolve.outputs.dist_path }}"
          if (-not (Test-Path $distPath)) {
            Write-Error "Built installer not found: $distPath"
            exit 1
          }

          $size = (Get-Item $distPath).Length
          if ($size -lt 5000000) {
            Write-Error "Built installer payload appears too small ($size bytes)."
            exit 1
          }

          Write-Host "Built installer verified: $distPath ($size bytes)"

      - name: Sync installer into tracked repo path
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $distPath = "${{ steps.resolve.outputs.dist_path }}"
          $repoPath = "${{ steps.resolve.outputs.repo_path }}"

          Copy-Item -Path $distPath -Destination $repoPath -Force
          Write-Host "Synced installer to tracked path: $repoPath"

      - name: Commit and push if changed
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $repoPath = "${{ steps.resolve.outputs.repo_path }}"
          $version = "${{ steps.resolve.outputs.version }}"
          $targetBranch = "${{ github.event.inputs.target_branch }}"

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add -- "$repoPath"

          if (-not (git diff --cached --quiet)) {
            git commit -m "chore(installer): sync SMS_Installer_$version.exe from dist"
            git push origin "HEAD:$targetBranch"
            Write-Host "âœ“ Installer artifact synced and pushed to $targetBranch"
          } else {
            Write-Host "No installer artifact changes detected. Nothing to commit."
          }

      - name: Summary
        shell: pwsh
        run: |
          $version = "${{ steps.resolve.outputs.version }}"
          $repoPath = "${{ steps.resolve.outputs.repo_path }}"

          @"
          ## Installer Artifact Sync Complete

          - Version: `$version`
          - Synced file: `$repoPath`
          - Target branch: `${{ github.event.inputs.target_branch }}`

          This workflow updates the tracked repository installer artifact without creating a GitHub Release.
          "@ | Add-Content -Path $env:GITHUB_STEP_SUMMARY
