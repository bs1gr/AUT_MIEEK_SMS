# Fix 1: COMMIT_READY Smoke Test
# File: .github/workflows/commit-ready-smoke.yml

name: COMMIT_READY Smoke (quick)

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - '**'

concurrency:
  group: commit-ready-smoke-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'

jobs:
  # Separate Ubuntu and Windows jobs for better isolation
  commit-ready-ubuntu:
    name: Run COMMIT_READY quick (Ubuntu)
    runs-on: ubuntu-latest
    timeout-minutes: 25  # Reduced from 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: |
            backend/requirements.txt
            backend/requirements-dev.txt

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install backend dependencies (fast)
        run: |
          python -m pip install --upgrade pip
          pip install ruff pytest mypy
          # Install full backend requirements to avoid missing optional deps
          pip install -r backend/requirements.txt

      - name: Install backend dev dependencies
        if: hashFiles('backend/requirements-dev.txt') != ''
        run: pip install -r backend/requirements-dev.txt

      - name: Install frontend deps
        run: |
          cd frontend
          npm ci --prefer-offline --no-audit

      - name: Run backend fast tests (pytest) and produce JUnit
        env:
          AUTH_MODE: strict
          DATABASE_URL: "sqlite:///:memory:"
        run: |
          echo "Running backend fast tests..."
          cd backend
          python -m pytest tests/ -m "not slow" -q --tb=short --junitxml=pytest-results.xml

      - name: Run frontend fast tests (vitest) and produce JUnit
        run: |
          echo "Running frontend fast tests..."
          cd frontend
          npx vitest run --reporter=junit --outputFile=vitest-results.xml

      - name: Run COMMIT_READY quick smoke (skip tests for speed)
        env:
          DEV_EASE: '1'
        shell: bash  # Use bash for cross-platform compatibility
        run: |
          set -o pipefail
          echo "Running COMMIT_READY quick smoke..."
          pwsh -NoProfile -ExecutionPolicy Bypass -File ./COMMIT_READY.ps1 -Mode quick -SkipTests -SkipCleanup -SkipPreCommitHooks -Verbose 2>&1 | tee commit_ready_output_ubuntu.txt
          echo "COMMIT_READY completed"

      - name: Upload smoke logs + JUnit test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: commit-ready-smoke-logs-ubuntu
          path: |
            commit_ready_output_ubuntu.txt
            backend/pytest-results.xml
            frontend/vitest-results.xml
          retention-days: 7

  commit-ready-windows:
    name: Run COMMIT_READY quick (Windows)
    runs-on: windows-latest
    timeout-minutes: 30  # Windows takes longer
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install backend dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install ruff pytest mypy
          pip install -r backend/requirements.txt
          if (Test-Path "backend/requirements-dev.txt") {
            pip install -r backend/requirements-dev.txt
          }

      - name: Install frontend deps
        shell: pwsh
        run: |
          cd frontend
          npm ci --prefer-offline --no-audit --legacy-peer-deps

      - name: Run backend fast tests (pytest)
        shell: pwsh
        env:
          AUTH_MODE: strict
          DATABASE_URL: "sqlite:///:memory:"
        run: |
          Write-Host "Running backend fast tests..."
          Push-Location backend
          python -m pytest tests/ -m "not slow" -q --tb=short --junitxml=pytest-results.xml
          Pop-Location

      - name: Run frontend fast tests (vitest)
        shell: pwsh
        run: |
          Write-Host "Running frontend fast tests..."
          Push-Location frontend
          npx vitest run --reporter=junit --outputFile=vitest-results.xml
          Pop-Location

      - name: Prepare installer Greek text assets
        shell: pwsh
        run: |
          Write-Host "Ensuring installer Greek text assets are regenerated"
          if (Test-Path "fix_greek_encoding_permanent.py") {
            python "fix_greek_encoding_permanent.py"
          } else {
            Write-Host "Skipping fix_greek_encoding_permanent.py (file not found)"
          }

      - name: Run COMMIT_READY quick smoke
        shell: pwsh
        env:
          DEV_EASE: '1'
        run: |
          Write-Host "Running COMMIT_READY quick smoke..."
          $outFile = "commit_ready_output_windows.txt"
          & ./COMMIT_READY.ps1 -Mode quick -SkipTests -SkipCleanup -SkipPreCommitHooks -Verbose *>&1 | Tee-Object -FilePath $outFile
          if ($LASTEXITCODE -ne 0) { Write-Error "COMMIT_READY failed with exit code $LASTEXITCODE"; exit $LASTEXITCODE }
          Write-Host "Wrote $outFile"

      - name: Upload smoke logs + JUnit test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: commit-ready-smoke-logs-windows
          path: |
            commit_ready_output_windows.txt
            backend/pytest-results.xml
            frontend/vitest-results.xml
          retention-days: 7
