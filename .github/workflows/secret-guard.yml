name: Secret guard

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  secret-check-blocking:
    name: Secret-key guard (blocking on main)
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare SECRET_KEY for CI (use repo secret if present, otherwise generate temporary)
        run: |
          if [ -n "${{ secrets.SECRET_KEY }}" ]; then
            echo "Using provided SECRET_KEY secret"
            echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" >> $GITHUB_ENV
          else
            echo "No SECRET_KEY secret found; generating a temporary secure key for CI"
            python - <<'PY' > /tmp/secret.txt
import secrets
print(secrets.token_urlsafe(48))
PY
            echo "SECRET_KEY=$(cat /tmp/secret.txt)" >> $GITHUB_ENV
          fi

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Run secret guard (blocking)
        # Make the guard blocking when this job runs on main (push)
        env:
          ENV: 'ci'
          BLOCK_ON_FAIL: 'true'
        run: |
          python -c 'import sys,platform; print("python:", sys.executable, platform.python_version())'
          python backend/tools/check_secret.py

  secret-check-informational:
    name: Secret-key guard (informational on PRs)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Run secret guard (non-fatal)
        env:
          ENV: 'ci'
        run: |
          python backend/tools/check_secret.py || echo "Secret guard detected an issue but PR checks will not block merge."
