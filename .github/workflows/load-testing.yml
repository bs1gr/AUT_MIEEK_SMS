name: Load Testing

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - development
        - staging
        - production
      duration:
        description: 'Test duration in minutes'
        required: false
        default: '5'
        type: string
      users:
        description: 'Number of concurrent users'
        required: false
        default: '100'
        type: string
  schedule:
    # Run weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  pull_request:
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'load-testing/**'

jobs:
  load-test:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment || 'development' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        cd load-testing
        pip install -r requirements.txt

    - name: Run smoke test
      run: |
        cd load-testing
        python scripts/run_load_tests.py --scenario smoke --env ${{ inputs.environment || 'development' }} --ci

    - name: Run load test
      run: |
        cd load-testing
        python scripts/run_load_tests.py \
          --scenario ${{ inputs.environment == 'production' && 'medium' || 'light' }} \
          --env ${{ inputs.environment || 'development' }} \
          --ci

    - name: Analyze results
      run: |
        cd load-testing
        python scripts/analyze_results.py --results-dir results/

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: load-test-results-${{ inputs.environment || 'development' }}-${{ github.run_number }}
        path: |
          load-testing/results/
          load-testing/reports/
        retention-days: 30

    - name: Performance regression check
      run: |
        cd load-testing
        python scripts/check_regression.py --baseline baseline.json --current results/analysis_*.json

    - name: Notify on failure
      if: failure()
      run: |
        echo "Load testing failed - check artifacts for details"
        # Add notification logic here (Slack, Teams, etc.)

  performance-report:
    runs-on: ubuntu-latest
    needs: load-test
    if: success()

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download test results
      uses: actions/download-artifact@v4
      with:
        name: load-test-results-${{ inputs.environment || 'development' }}-${{ github.run_number }}

    - name: Generate performance report
      run: |
        cd load-testing
        python scripts/generate_report.py --input results/ --output performance-report.html

    - name: Upload performance report
      uses: actions/upload-artifact@v4
      with:
        name: performance-report-${{ inputs.environment || 'development' }}-${{ github.run_number }}
        path: load-testing/performance-report.html
        retention-days: 90
