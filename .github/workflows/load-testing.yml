name: Load Testing

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - development
        - staging
        - production
      duration:
        description: 'Test duration in minutes'
        required: false
        default: '5'
        type: string
      users:
        description: 'Number of concurrent users'
        required: false
        default: '100'
        type: string
  schedule:
    # Run weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  pull_request:
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'load-testing/**'

concurrency:
  group: load-testing-${{ github.ref }}
  cancel-in-progress: true

jobs:
  load-test:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'development' }}
    env:
      SMS_ENV: ${{ github.event.inputs.environment || 'development' }}
      AUTH_MODE: disabled
      AUTH_ENABLED: 'false'
      CI_SKIP_AUTH: 'true'
      RATE_LIMIT_AUTH_PER_MINUTE: '1000000'
      RATE_LIMIT_READ_PER_MINUTE: '1000000'
      RATE_LIMIT_WRITE_PER_MINUTE: '1000000'
      RATE_LIMIT_HEAVY_PER_MINUTE: '1000000'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: |
          load-testing/requirements.txt
          backend/requirements.txt

    - name: Install dependencies
      run: |
        pip install -r load-testing/requirements.txt
        pip install -r backend/requirements.txt

    - name: Start backend server (background)
      run: |
        # Start uvicorn in background so load tests can target localhost:8080
        nohup python -m uvicorn backend.main:app --host 0.0.0.0 --port 8080 &>/dev/null &
        # Wait for backend to be ready
        for i in {1..30};
        do
          if curl -s http://127.0.0.1:8080/health > /dev/null; then
            echo "Backend is ready"
            break
          fi
          echo "Waiting for backend... ($i/30)"
          sleep 1
        done
        # Final check
        curl -f http://127.0.0.1:8080/health

    - name: Run smoke test
      run: |
        cd load-testing
        python scripts/run_load_tests.py --scenario smoke --env "${{ env.SMS_ENV }}" --ci

    - name: Run load test
      continue-on-error: true
      run: |
        cd load-testing
        python scripts/run_load_tests.py \
          --scenario ${{ github.event.inputs.environment == 'production' && 'medium' || 'light' }} \
          --env "${{ env.SMS_ENV }}" \
          --ci

    - name: Analyze results
      run: |
        cd load-testing
        python scripts/analyze_results.py --results-dir results/

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: load-test-results-${{ github.event.inputs.environment || 'development' }}-${{ github.run_number }}
        path: |
          load-testing/results/
          load-testing/reports/
        retention-days: 30

    - name: Performance regression check
      run: |
        cd load-testing
        python scripts/check_regression.py --baseline baseline.json --current results/analysis_*.json

    - name: Notify on failure
      if: failure()
      run: |
        echo "Load testing failed - check artifacts for details"
        # Add notification logic here (Slack, Teams, etc.)

  performance-report:
    runs-on: ubuntu-latest
    needs: load-test
    if: always()

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download test results
      uses: actions/download-artifact@v4
      with:
        name: load-test-results-${{ github.event.inputs.environment || 'development' }}-${{ github.run_number }}
        path: load-test-results

    - name: Generate performance report
      run: |
        cd load-testing
        python scripts/generate_report.py --input ../load-test-results/results/ --output performance-report.html

    - name: Upload performance report
      uses: actions/upload-artifact@v4
      with:
        name: performance-report-${{ github.event.inputs.environment || 'development' }}-${{ github.run_number }}
        path: load-testing/performance-report.html
        retention-days: 90
