name: Release Asset Sanitizer

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to sanitize (example: v1.18.1). Leave empty to use latest release."
        required: false
        type: string
  release:
    types: [published, edited, released, prereleased]
  schedule:
    - cron: "*/30 * * * *"

permissions:
  contents: write

concurrency:
  group: release-asset-sanitizer-${{ github.event.release.tag_name || github.ref_name || 'latest' }}
  cancel-in-progress: false

jobs:
  sanitize:
    runs-on: ubuntu-latest
    steps:
      - name: Resolve target release tag
        id: resolve
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          INPUT_TAG: ${{ github.event.inputs.tag }}
          EVENT_TAG: ${{ github.event.release.tag_name }}
        run: |
          set -euo pipefail

          TAG="${INPUT_TAG:-}"
          if [ -z "$TAG" ] && [ -n "${EVENT_TAG:-}" ]; then
            TAG="$EVENT_TAG"
          fi

          if [ -z "$TAG" ]; then
            TAG=$(gh release view --repo "$REPO" --json tagName --jq '.tagName')
          fi

          if [ -z "$TAG" ]; then
            echo "No release tag resolved; skipping."
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if ! [[ "$TAG" =~ ^v1\.[0-9]+\.[0-9]+$ ]]; then
            echo "Tag '$TAG' is not in supported v1.x.x format. Skipping sanitization."
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          VERSION="${TAG#v}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "skip=false" >> "$GITHUB_OUTPUT"

      - name: Sanitize release assets (installer-only allowlist)
        if: steps.resolve.outputs.skip == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          TAG: ${{ steps.resolve.outputs.tag }}
          VERSION: ${{ steps.resolve.outputs.version }}
        run: |
          set -euo pipefail

          ALLOWED_EXE="SMS_Installer_${VERSION}.exe"
          ALLOWED_SHA="SMS_Installer_${VERSION}.exe.sha256"

          echo "Sanitizing release '$TAG' in $REPO"
          echo "Allowed assets: $ALLOWED_EXE, $ALLOWED_SHA"

          mapfile -t ASSETS < <(gh release view "$TAG" --repo "$REPO" --json assets --jq '.assets[].name')

          if [ "${#ASSETS[@]}" -eq 0 ]; then
            echo "No assets found on release '$TAG'."
          fi

          REMOVED=0
          for ASSET in "${ASSETS[@]}"; do
            if [ "$ASSET" != "$ALLOWED_EXE" ] && [ "$ASSET" != "$ALLOWED_SHA" ]; then
              echo "Deleting non-allowlisted asset: $ASSET"
              gh release delete-asset "$TAG" "$ASSET" --repo "$REPO" --yes
              REMOVED=$((REMOVED + 1))
            fi
          done

          echo "Removed $REMOVED non-allowlisted asset(s)."

      - name: Verify release assets are clean
        if: steps.resolve.outputs.skip == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          TAG: ${{ steps.resolve.outputs.tag }}
          VERSION: ${{ steps.resolve.outputs.version }}
        run: |
          set -euo pipefail

          ALLOWED_EXE="SMS_Installer_${VERSION}.exe"
          ALLOWED_SHA="SMS_Installer_${VERSION}.exe.sha256"

          mapfile -t FINAL_ASSETS < <(gh release view "$TAG" --repo "$REPO" --json assets --jq '.assets[].name')

          printf 'Final assets on %s:\n' "$TAG"
          for A in "${FINAL_ASSETS[@]}"; do
            echo " - $A"
          done

          for A in "${FINAL_ASSETS[@]}"; do
            if [ "$A" != "$ALLOWED_EXE" ] && [ "$A" != "$ALLOWED_SHA" ]; then
              echo "❌ Unexpected asset remains: $A"
              exit 1
            fi
          done

          HAS_EXE=false
          HAS_SHA=false
          for A in "${FINAL_ASSETS[@]}"; do
            [ "$A" = "$ALLOWED_EXE" ] && HAS_EXE=true
            [ "$A" = "$ALLOWED_SHA" ] && HAS_SHA=true
          done

          if [ "$HAS_EXE" != true ] || [ "$HAS_SHA" != true ]; then
            echo "❌ Required installer assets are missing after sanitization."
            exit 1
          fi

          echo "✅ Release '$TAG' assets are clean and installer-only."
