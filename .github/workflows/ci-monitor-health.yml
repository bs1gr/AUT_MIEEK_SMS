name: CI Monitor Health

on:
  schedule:
    - cron: '0 0 * * 0' # weekly on Sundays at 00:00 UTC
  workflow_dispatch:

jobs:
  dispatch-failing-workflow:
    name: Dispatch failing test workflow (health check)
    runs-on: ubuntu-latest
    steps:
      - name: Dispatch failing workflow via PAT (curl)
        env:
          CI_MONITOR_TOKEN: ${{ secrets.CI_MONITOR_TOKEN }}
          REPO: ${{ github.repository }}
          OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name || github.repository }}
        run: |
          set -euo pipefail
          if [ -z "${CI_MONITOR_TOKEN:-}" ]; then
            echo "CI_MONITOR_TOKEN not set — skipping dispatch."
            exit 0
          fi
          API_URL="https://api.github.com/repos/${OWNER}/${{ github.event.repository.name || github.repository }}" || true
          WORKFLOW_ID="ci-failure-monitor-test.yml"
          PAYLOAD=$(jq -n --arg ref "main" '{ref: $ref}')
          echo "Dispatching $WORKFLOW_ID on ref main for repo ${OWNER}/${{ github.event.repository.name || github.repository }}"
          resp_file=dispatch_response.json
          http_status=$(curl -s -w "%{http_code}" -o "$resp_file" -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${CI_MONITOR_TOKEN}" \
            -d "$PAYLOAD" \
            "https://api.github.com/repos/${OWNER}/${{ github.event.repository.name || github.repository }}/actions/workflows/${WORKFLOW_ID}/dispatches")
          echo "HTTP status: $http_status"
          if [ "$http_status" -ne 204 ]; then
            echo "Dispatch failed — response saved to $resp_file"
          else
            echo "Dispatch accepted (204)."
          fi

      - name: Upload dispatch response artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci_monitor_dispatch_response
          path: dispatch_response.json

      - name: Note
        run: |
          echo "This workflow will attempt to dispatch the deliberate failing workflow when a valid CI_MONITOR_TOKEN secret is present."
