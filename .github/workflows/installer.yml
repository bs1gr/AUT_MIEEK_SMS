name: Windows Installer Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: Build Installer
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cache Inno Setup
        uses: actions/cache@v4
        with:
          path: C:\ProgramData\chocolatey\lib\innosetup
          key: ${{ runner.os }}-innosetup-1

      - name: Install Inno. Setup
        run: choco install innosetup --no-progress

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Build SMS Manager launcher
        shell: pwsh
        run: |
          dotnet restore .\installer\SMS_Manager\SMS_Manager.csproj
          dotnet publish .\installer\SMS_Manager\SMS_Manager.csproj -c Release -r win-x64 --self-contained true -p:PublishSingleFile=true -p:PublishTrimmed=false -p:IncludeNativeLibrariesForSelfExtract=true

          $managerExe = '.\installer\dist\SMS_Manager.exe'
          if (-not (Test-Path $managerExe)) {
            Write-Error "SMS_Manager.exe was not produced at expected path: $managerExe"
            exit 1
          }

          Write-Host "SMS_Manager.exe ready: $managerExe" -ForegroundColor Green

      - name: Build Installer
        shell: pwsh
        run: |
          ./INSTALLER_BUILDER.ps1 -Action build -SkipCodeSign -Verbose -AutoFix
        env:
          CI: 'true'

      - name: Verify Installer Signature (Fail-Fast)
        shell: pwsh
        run: |
          Write-Host "Verifying installer signature..." -ForegroundColor Cyan
          $installer = Get-ChildItem -Path dist -Filter "SMS_Installer_*.exe" | Select-Object -First 1
          if (-not $installer) {
            Write-Error "No installer found in dist/"
            exit 1
          }

          $sig = Get-AuthenticodeSignature $installer.FullName
          Write-Host "Signature Status: $($sig.Status)" -ForegroundColor $(if ($sig.Status -eq 'Valid') { 'Green' } else { 'Red' })

          if ($sig.Status -ne 'Valid') {
            # Soft-fail for CI without cert; production builds should have cert
            if ($env:SMS_CODESIGN_REQUIRED -eq 'true') {
              Write-Error "Build blocked: Installer must be signed. Status: $($sig.Status)"
              exit 1
            } else {
              Write-Warning "Unsigned installer in CI (SMS_CODESIGN_REQUIRED not set to 'true')"
              Write-Host "Note: CI builds currently skip signing (-SkipCodeSign). For production releases, ensure certificate is available." -ForegroundColor Yellow
              Write-Host "âœ… Soft-fail: Allowing unsigned installer for CI build" -ForegroundColor Green
            }
          }

          if ($sig.Status -eq 'Valid') {
            $subject = $sig.SignerCertificate.Subject
            Write-Host "Signer: $subject" -ForegroundColor Green
            if ($subject -notmatch 'L=Limassol' -or $subject -notmatch 'C=CY') {
              Write-Error "Signer does not match required certificate (Limassol/CY)"
              exit 1
            }
          }

      - name: Upload Installer Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SMS_Installer
          path: dist/*.exe
          if-no-files-found: error
