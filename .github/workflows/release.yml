name: Release Images

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build backend image for verification
        run: |
          docker build -f docker/Dockerfile.backend -t sms-backend:ci-verify .

      - name: Run backend tests inside Docker
        run: |
          docker run --rm -e TESTING=true --entrypoint pytest sms-backend:ci-verify -q

      - name: Verify frontend build via fullstack image
        run: |
          docker build -f docker/Dockerfile.fullstack -t sms-fullstack:ci-verify .

      - name: Log in to GHCR (docker CLI)
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.repository_owner }}" --password-stdin

      - name: Extract metadata (tags, labels)
        id: meta
        run: |
          # Minimal labels metadata used by docker builds
          echo "labels=org.opencontainers.image.revision=${GITHUB_SHA}" >> $GITHUB_OUTPUT

      - name: Build and push backend (docker CLI)
        id: build_backend
        run: |
          IMAGE=ghcr.io/${{ github.repository_owner }}/sms-backend
          docker build -f docker/Dockerfile.backend -t ${IMAGE}:latest -t ${IMAGE}:${{ github.sha }} --label "${{ steps.meta.outputs.labels }}" .
          docker push ${IMAGE}:latest
          docker push ${IMAGE}:${{ github.sha }}
          # Read pushed image digest (RepoDigest format: repo@sha256:...)
          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' ${IMAGE}:${{ github.sha }} 2>/dev/null || true)
          if [ -n "$DIGEST" ]; then echo "digest=${DIGEST#*@}" >> $GITHUB_OUTPUT; else echo "digest=" >> $GITHUB_OUTPUT; fi

      - name: Build and push frontend (docker CLI)
        id: build_frontend
        run: |
          IMAGE=ghcr.io/${{ github.repository_owner }}/sms-frontend
          docker build -f docker/Dockerfile.frontend -t ${IMAGE}:latest -t ${IMAGE}:${{ github.sha }} --label "${{ steps.meta.outputs.labels }}" .
          docker push ${IMAGE}:latest
          docker push ${IMAGE}:${{ github.sha }}
          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' ${IMAGE}:${{ github.sha }} 2>/dev/null || true)
          if [ -n "$DIGEST" ]; then echo "digest=${DIGEST#*@}" >> $GITHUB_OUTPUT; else echo "digest=" >> $GITHUB_OUTPUT; fi

      - name: Build and push fullstack (docker CLI)
        id: build_fullstack
        run: |
          IMAGE=ghcr.io/${{ github.repository_owner }}/sms-fullstack
          docker build -f docker/Dockerfile.fullstack -t ${IMAGE}:latest -t ${IMAGE}:${{ github.sha }} --label "${{ steps.meta.outputs.labels }}" .
          docker push ${IMAGE}:latest
          docker push ${IMAGE}:${{ github.sha }}
          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' ${IMAGE}:${{ github.sha }} 2>/dev/null || true)
          if [ -n "$DIGEST" ]; then echo "digest=${DIGEST#*@}" >> $GITHUB_OUTPUT; else echo "digest=" >> $GITHUB_OUTPUT; fi
