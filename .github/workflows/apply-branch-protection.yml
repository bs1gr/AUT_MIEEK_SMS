name: Apply branch protection (admin)

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to protect'
        required: false
        default: 'main'
      contexts:
        description: 'Comma-separated required check names (e.g. Import checker,Require operator approval for operator scripts,CI)'
        required: false
        default: 'Import checker,Require operator approval for operator scripts,CI'

jobs:
  apply-protection:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    steps:
      - name: Apply branch protection via octokit
        uses: actions/github-script@v6
        with:
          # Use the workflow's GITHUB_TOKEN (granted to this run) so admins can dispatch
          # without storing an external PAT. The run must be triggered by a user with
          # sufficient repository permissions and the workflow needs write permissions
          # to `contents` (declared above).
          github-token: ${{ github.token }}
          script: |
            const core = require('@actions/core');
            const inputs = core.getInput('contexts') || '';
            const contexts = inputs.split(',').map(s => s.trim()).filter(Boolean);
            const branch = core.getInput('branch') || context.ref.replace('refs/heads/', '') || 'main';
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            core.info(`Applying branch protection to ${owner}/${repo}@${branch} with checks: ${contexts.join(', ')}`);

            const params = {
              owner,
              repo,
              branch,
              required_status_checks: {
                strict: true,
                contexts: contexts
              },
              enforce_admins: true,
              required_pull_request_reviews: {
                dismiss_stale_reviews: true,
                require_code_owner_reviews: true,
                required_approving_review_count: 1
              },
              restrictions: {
                users: [owner],
                teams: []
              }
            };

            try {
              await github.rest.repos.updateBranchProtection(params);
              core.info('Branch protection applied successfully.');
              await github.rest.issues.createComment({ owner, repo, issue_number: context.payload.issue ? context.payload.issue.number : context.payload.pull_request ? context.payload.pull_request.number : undefined, body: `Branch protection applied to ${branch} by workflow run.` }).catch(() => {});
            } catch (err) {
              core.setFailed('Failed to apply branch protection: ' + err.message);
            }
