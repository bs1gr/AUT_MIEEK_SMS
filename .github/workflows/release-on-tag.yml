
name: Create GitHub Release on tag

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v1.6.0)'
        required: true
        type: string

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.get_tag.outputs.tag_name }}
      release_created: ${{ steps.create_release.outputs.created }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get tag name
        id: get_tag
        run: |
          TAG_NAME=""
          if [ -n "${{ inputs.tag }}" ]; then
            TAG_NAME="${{ inputs.tag }}"
          else
            TAG_NAME="${{ github.ref_name }}"
          fi
          TRIMMED_TAG=$(echo "$TAG_NAME" | xargs)
          echo "tag_name=$TRIMMED_TAG" >> $GITHUB_OUTPUT
          echo "Debug: tag_name=$TRIMMED_TAG"

      - name: Prepare release body
        id: prepare
        run: |
          TAG=$(echo "${{ steps.get_tag.outputs.tag_name }}" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          echo "Debug: TAG after trim = '${TAG}'"
          NOTES_FILE=".github/RELEASE_NOTES_${TAG}.md"
          if [ -f "$NOTES_FILE" ]; then
            BODY=$(cat "$NOTES_FILE")
          else
            BODY="Release ${TAG}"
          fi
          # Encode body as base64 to safely pass through GitHub Actions
          BODY_B64=$(echo -n "$BODY" | base64 -w 0)
          echo "body_b64=${BODY_B64}" >> $GITHUB_OUTPUT

      - name: Create release (or update if exists)
        id: create_release
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const tag = '${{ steps.get_tag.outputs.tag_name }}';
            // Decode base64 body
            const body = Buffer.from('${{ steps.prepare.outputs.body_b64 }}', 'base64').toString('utf-8');
            try {
              // Try to fetch existing release
              const release = await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag: tag,
              });
              console.log(`Release ${tag} already exists (ID: ${release.data.id}). Updating body...`);
              // Update the existing release
              await github.rest.repos.updateRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: release.data.id,
                body: body,
              });
              core.setOutput('created', 'false');
              core.setOutput('release_id', release.data.id);
            } catch (error) {
              if (error.status === 404) {
                // Release doesn't exist, create it
                console.log(`Release ${tag} not found. Creating...`);
                const newRelease = await github.rest.repos.createRelease({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  tag_name: tag,
                  name: tag,
                  body: body,
                  draft: false,
                  prerelease: false,
                });
                core.setOutput('created', 'true');
                core.setOutput('release_id', newRelease.data.id);
              } else {
                throw error;
              }
            }

  # Trigger the installer build workflow
  trigger-installer-build:
    runs-on: ubuntu-latest
    needs: create-release
    steps:
      - name: Trigger Release Installer Workflow
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const tag = '${{ needs.create-release.outputs.tag }}';
            console.log(`Triggering installer build workflow for tag: ${tag}`);

            try {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'release-installer-with-sha.yml',
                ref: 'main',
                inputs: {
                  tag: tag
                }
              });
              console.log(`✓ Installer build workflow dispatched for ${tag}`);
            } catch (error) {
              console.error(`Failed to dispatch installer workflow: ${error.message}`);
              // Don't fail the entire job if workflow dispatch fails
              // The user can manually trigger it if needed
            }

  # Trigger the full CI/CD pipeline for release validation
  trigger-ci-cd-pipeline:
    runs-on: ubuntu-latest
    needs: create-release
    if: needs.create-release.outputs.release_created == 'true'
    steps:
      - name: Trigger CI/CD Pipeline
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const tag = '${{ needs.create-release.outputs.tag }}';
            console.log(`Triggering CI/CD pipeline for new release: ${tag}`);

            try {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'ci-cd-pipeline.yml',
                ref: 'main',
                inputs: {
                  deploy_environment: 'production'
                }
              });
              console.log(`✓ CI/CD pipeline dispatched for ${tag}`);
            } catch (error) {
              console.error(`Failed to dispatch CI/CD pipeline: ${error.message}`);
            }
