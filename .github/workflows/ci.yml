name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  backend:
    name: Backend checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache pip + wheelhouse
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.cache/pip/wheels
            ./.wheelhouse
          key: ${{ runner.os }}-pip-wheelhouse-${{ hashFiles('backend/requirements-lock.txt', 'backend/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-wheelhouse-

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python build tools
        run: |
          python -m pip install --upgrade pip

            try {
              reportText = fs.readFileSync('backend/ruff-report.json', 'utf8');
            } catch (err) {
              // keep fallback
            }
            // Truncate long outputs to keep the check run compact
            const maxLen = 60_000;
            const truncated = reportText.length > maxLen ? reportText.slice(0, maxLen) + '\n\n...truncated...' : reportText;
            const body = `Ruff artifact validation failed. Normalized report (truncated if large):\n\n\n${truncated}`;
            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'ruff-validation',
              head_sha: headSha,
              status: 'completed',
              conclusion: 'failure',
              output: {
                title: 'Ruff artifact validation failed',
                summary: 'The normalized Ruff JSON failed validation in CI. See output below.',
                text: body,
              },
            });

      - name: Cleanup temporary ruff files
        run: |
          rm -f backend/ruff-raw.json backend/ruff-stdout.txt backend/ruff-stderr.txt backend/ruff-report.err backend/ruff-stderr.log || true

      - name: Upload ruff report
        uses: actions/upload-artifact@v4
        with:
          name: ruff-report
          path: backend/ruff-report.json

      - name: Upload mypy report
        uses: actions/upload-artifact@v4
        with:
          name: mypy-report
          path: backend/mypy-report.txt

  validator-tests:
    name: Validator unit tests (fast)
    runs-on: ubuntu-latest
    # Keep this job independent and fast: it only runs the ruff-validator unit tests
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download wheelhouse artifact (if available)
        uses: actions/download-artifact@v4
        with:
          name: wheelhouse
          path: ./.wheelhouse
        continue-on-error: true

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Cache pip + wheelhouse
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.cache/pip/wheels
            ./.wheelhouse
          key: ${{ runner.os }}-pip-wheelhouse-${{ hashFiles('backend/requirements-lock.txt', 'backend/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-wheelhouse-

      - name: Install Python build tools
        run: |
          python -m pip install --upgrade pip

      - name: Install runtime deps (locked when available) - prefer wheelhouse
        run: |
          # Prefer a minimal runtime requirements file for fast validator tests.
          if [ -f backend/requirements-runtime.txt ]; then
            if [ -d ./.wheelhouse ] && [ "$(ls -A ./.wheelhouse)" ]; then
              pip install --no-index --find-links ./.wheelhouse -r backend/requirements-runtime.txt
            else
              pip wheel --wheel-dir ./.wheelhouse -r backend/requirements-runtime.txt || true
              pip install --no-index --find-links ./.wheelhouse -r backend/requirements-runtime.txt
            fi
          else
            echo "No runtime requirements provided; skipping full backend deps install"
          fi

      - name: Install test helpers
        run: |
          pip install pytest jsonschema

      - name: Run validator unit tests
        run: |
          pytest -q .github/tests/test_validate_ruff_report.py

  release-candidate:
    name: Draft release (manual)
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4
      - name: Create draft GitHub release (via github-script)
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const runNumber = process.env.GITHUB_RUN_NUMBER || '';
            const tag = `rc-${runNumber}`;
            await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tag,
              name: `Release candidate ${runNumber}`,
              draft: true,
              prerelease: true,
            });
