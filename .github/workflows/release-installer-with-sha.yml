name: Release - Build & Upload Installer with SHA256

on:
  release:
    types: [published, created]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v1.12.0)'
        required: true

jobs:
  release-installer:
    runs-on: windows-latest
    name: Build & Upload Installer with SHA256

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Inno Setup 6
        shell: pwsh
        run: |
          choco install innosetup -y --no-progress
          $paths = @(
            "C:\\Program Files (x86)\\Inno Setup 6",
            "C:\\Program Files\\Inno Setup 6",
            "$env:LOCALAPPDATA\Programs\Inno Setup 6"
          )
          foreach ($p in $paths) {
            if (Test-Path $p) {
              Write-Host "Inno Setup installed at $p"
              $env:PATH += ";$p"
              break
            }
          }

      - name: Get release information
        id: release_info
        shell: pwsh
        run: |
          if ("${{ github.event_name }}" -eq "release") {
            echo "tag=${{ github.event.release.tag_name }}" >> $env:GITHUB_OUTPUT
            echo "release_id=${{ github.event.release.id }}" >> $env:GITHUB_OUTPUT
          } else {
            echo "tag=${{ github.event.inputs.tag }}" >> $env:GITHUB_OUTPUT
          }
          $version = ("${{ github.event_name }}" -eq "release") ? "${{ github.event.release.tag_name }}" : "${{ github.event.inputs.tag }}"
          $version = $version -replace '^v', ''
          echo "version=$version" >> $env:GITHUB_OUTPUT

      - name: Import code signing certificate (from secrets)
        id: import_cert
        shell: pwsh
        env:
          CODESIGN_PFX_BASE64: ${{ secrets.CODESIGN_PFX_BASE64 }}
          CODESIGN_PFX_PASSWORD: ${{ secrets.CODESIGN_PFX_PASSWORD }}
        run: |
          if (-not $env:CODESIGN_PFX_BASE64 -or -not $env:CODESIGN_PFX_PASSWORD) {
            Write-Host "Code signing certificate secrets not provided. Skipping import (signing will be skipped)."
            exit 0
          }

          $pfxPath = Join-Path $env:RUNNER_TEMP "sms_codesign.pfx"
          [IO.File]::WriteAllBytes($pfxPath, [Convert]::FromBase64String($env:CODESIGN_PFX_BASE64))

          $securePassword = ConvertTo-SecureString $env:CODESIGN_PFX_PASSWORD -AsPlainText -Force
          Import-PfxCertificate -FilePath $pfxPath -CertStoreLocation "Cert:\CurrentUser\My" -Password $securePassword | Out-Null

          "pfx_path=$pfxPath" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          Write-Host "Code signing certificate imported to CurrentUser store."

      - name: Verify version consistency
        shell: pwsh
        run: |
          Write-Host "Verifying version consistency across all files..."
          $tag = "${{ steps.release_info.outputs.tag }}"
          $version = $tag -replace '^v', ''
          
          Write-Host "Expected version: $version (from tag: $tag)"
          
          if (Test-Path ".\scripts\VERIFY_VERSION.ps1") {
            Write-Host "Running VERIFY_VERSION.ps1 in CI mode..."
            & ".\scripts\VERIFY_VERSION.ps1" -CIMode
            if ($LASTEXITCODE -ne 0) {
              Write-Error "Version verification failed! Please run 'COMMIT_READY.ps1 -Quick' to fix version inconsistencies before release."
              exit 1
            }
            Write-Host "Version verification passed!"
          } else {
            Write-Warning "Version verification script not found, skipping..."
          }

      - name: Build installer
        shell: pwsh
        env:
          SMS_CODESIGN_PFX_PATH: ${{ steps.import_cert.outputs.pfx_path }}
          SMS_CODESIGN_PFX_PASSWORD: ${{ secrets.CODESIGN_PFX_PASSWORD }}
        run: |
          Write-Host "Building installer..."
          & ".\INSTALLER_BUILDER.ps1" -AutoFix
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Installer build failed"
            exit 1
          }

      - name: Verify installer exists
        id: verify_installer
        shell: pwsh
        run: |
          $tag = "${{ steps.release_info.outputs.tag }}"
          $version = "${{ steps.release_info.outputs.version }}"
          
          Write-Host "=== Installer Search Debug Info ==="
          Write-Host "Tag: $tag"
          Write-Host "Version: $version"
          Write-Host "Current directory: $(Get-Location)"
          Write-Host ""
          
          # Show what actually exists in dist/
          Write-Host "Contents of dist/ directory:"
          if (Test-Path "dist") {
            Get-ChildItem "dist" -Filter "*.exe" | ForEach-Object { 
              Write-Host "  - $($_.Name) ($([math]::Round($_.Length/1MB, 2)) MB)"
            }
          } else {
            Write-Host "  dist/ directory does not exist!"
          }
          Write-Host ""
          
          # Search patterns in priority order
          $installers = @(
            "dist\SMS_Installer_${version}.exe",
            "dist\SMS_Installer_${tag}.exe",
            "dist\SMS_Installer.exe",
            "SMS_Installer_${version}.exe",
            "SMS_Installer_${tag}.exe",
            "SMS_Installer.exe"
          )
          
          Write-Host "Searching for installer in these locations:"
          $installers | ForEach-Object { Write-Host "  - $_" }
          Write-Host ""
          
          $found = $false
          foreach ($path in $installers) {
            if (Test-Path $path) {
              Write-Host "âœ“ Found installer: $path"
              echo "path=$path" >> $env:GITHUB_OUTPUT
              $found = $true
              break
            }
          }
          
          if (-not $found) {
            Write-Host ""
            Write-Host "=== Recursive Search for SMS_Installer*.exe ==="
            Get-ChildItem -Path "." -Recurse -Filter "SMS_Installer*.exe" -ErrorAction SilentlyContinue | ForEach-Object { 
              Write-Host "  Found: $($_.FullName)"
            }
            Write-Error "Installer not found in any expected location"
            exit 1
          }

      - name: Calculate SHA256 hash
        id: hash
        shell: pwsh
        run: |
          $installer = "${{ steps.verify_installer.outputs.path }}"
          
          if (-not (Test-Path $installer)) {
            Write-Error "Installer not found at: $installer"
            exit 1
          }
          
          $hash = (Get-FileHash $installer -Algorithm SHA256).Hash
          $fileSize = (Get-Item $installer).Length
          $fileSizeMB = [math]::Round($fileSize / 1MB, 2)
          echo "sha256=$hash" >> $env:GITHUB_OUTPUT
          echo "size=$fileSizeMB" >> $env:GITHUB_OUTPUT
          echo "path=$installer" >> $env:GITHUB_OUTPUT
          Write-Host "File: $installer"
          Write-Host "Size: $fileSizeMB MB"
          Write-Host "SHA256: $hash"

      - name: Generate release body with installer info
        id: release_body
        shell: pwsh
        run: |
          $tag = "${{ steps.release_info.outputs.tag }}"
          $sha256 = "${{ steps.hash.outputs.sha256 }}"
          $size = "${{ steps.hash.outputs.size }} MB"
          
          $notesFile = "RELEASE_NOTES_${tag}.md"
          $releaseNotes = ""
          if (Test-Path $notesFile) {
            $releaseNotes = Get-Content $notesFile -Raw
          }
          
          $installerInfo = "## Installer Download`n`n"
          $installerInfo += "**File**: SMS_Installer_${tag}.exe`n"
          $installerInfo += "**Size**: ${size}`n"
          $installerInfo += "**SHA256**: \`${sha256}\``n`n"
          $installerInfo += "### Verify Installer Integrity`n`n"
          $installerInfo += "PowerShell:`n"
          $installerInfo += "``````powershell`n"
          $installerInfo += "(Get-FileHash 'SMS_Installer_${tag}.exe' -Algorithm SHA256).Hash`n"
          $installerInfo += "``````n"
          $installerInfo += "`nExpected: ${sha256}`n"
          
          $body = $releaseNotes + "`n`n" + $installerInfo
          $body | Out-File -FilePath "release_body.md" -Encoding UTF8
          Write-Host "Release body generated"

      - name: Upload installer to release
        if: github.event_name == 'release' && steps.hash.outputs.path != ''
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ${{ steps.hash.outputs.path }}
          asset_name: SMS_Installer_${{ steps.release_info.outputs.tag }}.exe
          asset_content_type: application/octet-stream

      - name: Create release summary
        shell: pwsh
        run: |
          $tag = "${{ steps.release_info.outputs.tag }}"
          $sha256 = "${{ steps.hash.outputs.sha256 }}"
          $size = "${{ steps.hash.outputs.size }}"
          
          $summary = @"
          ## Release $tag - Installer Ready
          
          - Installer: SMS_Installer_${tag}.exe
          - Size: ${size} MB
          - SHA256: ${sha256}
          
          The installer is available as a release asset.
          "@
          
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value $summary

      - name: Post success notification
        if: success()
        run: |
          Write-Host "Release workflow completed successfully"
          Write-Host "- Installer: SMS_Installer_${{ steps.release_info.outputs.tag }}.exe"
          Write-Host "- Size: ${{ steps.hash.outputs.size }} MB"
          Write-Host "- SHA256: ${{ steps.hash.outputs.sha256 }}"
        shell: pwsh

  notify-failure:
    runs-on: ubuntu-latest
    needs: release-installer
    if: failure()
    name: Release Failure Notification

    steps:
      - name: Notify failure
        run: echo "Release workflow failed - check logs for details"
