name: CI Failure Monitor Reconcile

on:
  schedule:
    - cron: '0 * * * *' # hourly
  workflow_dispatch:

jobs:
  reconcile:
    name: Reconcile recent failed workflow runs
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      actions: read

    steps:
      - name: Reconcile failed runs (last 24h)
        env:
          TOKEN: ${{ secrets.CI_MONITOR_TOKEN }}
          REPO_FULL: ${{ github.repository }}
        run: |
          set -euo pipefail
          audit_file=reconcile_audit.json
          # initialize audit file
          echo '[]' > "$audit_file"

          if [ -z "${TOKEN:-}" ]; then
            echo "CI_MONITOR_TOKEN not set; skipping reconciliation. Writing audit file indicating skip."
            printf '{"skipped": true, "reason": "CI_MONITOR_TOKEN not set"}\n' > "$audit_file"
            exit 0
          fi

          cutoff=$(date -u -d '24 hours ago' +"%Y-%m-%dT%H:%M:%SZ")
          echo "Cutoff (UTC): $cutoff"

          page=1
          while :; do
            echo "Fetching page $page of workflow runs"
            resp=$(curl -s -H "Authorization: token ${TOKEN}" "https://api.github.com/repos/${REPO_FULL}/actions/runs?status=completed&per_page=100&page=${page}")
            runs_count=$(echo "$resp" | jq '.workflow_runs | length')
            if [ "$runs_count" -eq 0 ]; then
              echo "No more runs; stopping."
              break
            fi

            echo "$resp" | jq -c '.workflow_runs[] | select(.conclusion=="failure" and (.created_at > "'"$cutoff"'"))' | while read -r run; do
              id=$(echo "$run" | jq -r '.id')
              name=$(echo "$run" | jq -r '.name')
              branch=$(echo "$run" | jq -r '.head_branch')
              sha=$(echo "$run" | jq -r '.head_sha')
              html=$(echo "$run" | jq -r '.html_url')
              title="CI failure: ${name} (${branch})"

              # Search for existing issue with label ci-failure that contains the run URL in body
              query="repo:${REPO_FULL} label:ci-failure \"${html}\" in:body"
              qenc=$(printf '%s' "$query" | jq -s -R -r @uri)
              search_url="https://api.github.com/search/issues?q=${qenc}"
              search_resp=$(curl -s -H "Authorization: token ${TOKEN}" -H "Accept: application/vnd.github+json" "$search_url")
              found=$(echo "$search_resp" | jq -r '.total_count')
              if [ "$found" -gt 0 ]; then
                echo "Issue already exists for run ${id} (found=${found}). Skipping."
                # append audit entry for skipped run
                tmp=$(mktemp)
                jq --arg id "$id" --arg html "$html" --arg name "$name" --arg branch "$branch" --arg found "$found" '. + [ {run_id: ($id|tonumber), run_url: $html, workflow_name: $name, branch: $branch, status: "skipped", existing_issues: ($found|tonumber)} ]' "$audit_file" > "$tmp" && mv "$tmp" "$audit_file"
                continue
              fi

              body="A workflow run failed on branch **${branch}**.\n\nWorkflow: ${name}\nCommit: ${sha}\nRun URL: ${html}\n\n(Automated reconciliation)"
              payload=$(jq -n --arg title "$title" --arg body "$body" '{title:$title, body:$body, labels:["ci-failure"]}')

              echo "Creating issue for run ${id}"
              issue_resp=$(curl -s -H "Authorization: token ${TOKEN}" -H "Accept: application/vnd.github+json" -X POST -d "$payload" "https://api.github.com/repos/${REPO_FULL}/issues")
              issue_html=$(echo "$issue_resp" | jq -r '.html_url // empty')
              issue_num=$(echo "$issue_resp" | jq -r '.number // 0')
              echo "Created issue: ${issue_html} (#${issue_num})"

              # append audit entry for created issue
              tmp=$(mktemp)
              jq --arg id "$id" --arg html "$html" --arg name "$name" --arg branch "$branch" --arg issue_html "$issue_html" --argjson issue_num "$issue_num" '. + [ {run_id: ($id|tonumber), run_url: $html, workflow_name: $name, branch: $branch, status: "created", issue_number: $issue_num, issue_url: $issue_html} ]' "$audit_file" > "$tmp" && mv "$tmp" "$audit_file"
            done

            if [ "$runs_count" -lt 100 ]; then
              break
            fi
            page=$((page+1))
          done

      - name: Upload reconciliation audit artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci_reconcile_audit
          path: reconcile_audit.json
