name: CI

on:
  pull_request:
    # ⚠️ CRITICAL: Do NOT use 'paths' here.
    # The workflow must trigger on every PR to report a status back to GitHub.

jobs:
  # JOB 1: Detect which files changed
  changes:
    runs-on: ubuntu-latest
    # Declare outputs for the next job to read
    outputs:
      should_run: ${{ steps.filter.outputs.src }}
    steps:
      - name: Detect file changes
        uses: actions/github-script@v6
        id: filter
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              core.setOutput('src', 'true');
              return;
            }
            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });
            const patterns = [/^src\//, /^package\.json$/, /^yarn\.lock$/, /^scripts\//];
            const changed = files.some(f => patterns.some(p => p.test(f.filename)));
            core.setOutput('src', changed ? 'true' : 'false');

  # JOB 2: The heavy CI job (Build/Test)
  ci-check:
    needs: changes
    # ⚠️ LOGIC: Only run if 'src' filter matched, OR if the workflow was manually triggered
    if: ${{ needs.changes.outputs.should_run == 'true' }}

    # This name must match the "Required Status Check" in branch protection
    name: CI
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Run Tests
        run: echo "Running heavy tests (npm test, build, etc)..."
