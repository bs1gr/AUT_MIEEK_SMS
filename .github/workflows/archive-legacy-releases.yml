name: Archive legacy releases

on:
  workflow_dispatch:
    inputs:
      threshold_tag:
        description: "Highest tag (inclusive) to archive"
        required: true
        default: "v1.6.2"
        type: string
      dry_run:
        description: "Preview changes without editing releases"
        required: true
        default: true
        type: boolean

jobs:
  archive:
    name: Run archive helper
    runs-on: windows-latest
    permissions:
      contents: write
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show gh auth status
        shell: pwsh
        run: gh auth status --show-token-scopes

      - name: Execute archive script
        shell: pwsh
        run: |
          $dryRun = '${{ inputs.dry_run }}' -ieq 'true'
          $scriptPath = Join-Path $PWD 'scripts/ops/archive-releases.ps1'
          $commonArgs = @('-Repo', '${{ github.repository }}', '-ThresholdTag', '${{ inputs.threshold_tag }}')
          if ($dryRun) {
            Write-Host "Running in DRY-RUN mode"
            $commonArgs += '-DryRun'
          } else {
            Write-Host "Live mode: releases meeting the criteria will be updated"
          }
          & pwsh -NoProfile -File $scriptPath @commonArgs
