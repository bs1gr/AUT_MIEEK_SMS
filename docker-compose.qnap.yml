version: "3.9"

services:
  backend:
    build:
      context: ./
      dockerfile: docker/Dockerfile.backend
    container_name: sms-backend
    environment:
      - DATABASE_URL=sqlite:///./data/sms.db
      - CORS_ORIGINS=http://172.16.0.2:8080
      - SERVE_FRONTEND=0
    volumes:
      - sms_data_qnap:/app/data
    networks:
      - sms_net

  frontend:
    build:
      context: ./frontend
      dockerfile: ../docker/Dockerfile.frontend
      args:
        VITE_API_URL: "/api"
    container_name: sms-frontend
    ports:
      - "8080:80"
    depends_on:
      - backend
    networks:
      - sms_net

  nginx:
    image: nginx:alpine
    container_name: sms-nginx
    depends_on:
      - backend
      - frontend
    volumes:
      - ./docker/nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      - "8080:80"
    networks:
      - sms_net
    # Note: If you prefer to serve SPA directly from the frontend container,
    # you can omit this nginx service and rely on the frontend's built-in NGINX.

networks:
  sms_net:
    driver: bridge

volumes:
  sms_data_qnap:
    # On QNAP, you can map to a specific host path in Container Station UI
    # or convert this to a bind mount like:
    # driver_opts:
    #   type: none
    #   o: bind
    #   device: /share/Container/sms_data
