# Release Notes – v1.6.5

## Highlights

- **Canonical Control API path** – The control router now lives outside the `api/v1` prefix so every operational endpoint is available under `/control/api/*`. The documentation set, pytest suites, and Vitest cases were refreshed to describe the new URL map, and `RUN.ps1`/`SMART_SETUP.ps1` automatically expose the canonical base.
- **Shared Control API base URL helper** – Frontend components and utilities now consume a single `CONTROL_API_BASE` export, eliminating copy/pasted string concatenation and making it trivial to retarget the Control Panel against self-hosted backends. Bulk backup/download/restore flows and their unit tests already reference the helper.
- **Restart UX polish** – Restart buttons now surface backend-provided hints, clearly explain when Docker mode blocks restarts, and defer to localized fallback text when hints are absent. The README’s restart enablement guide calls out the new environment variables plus the host-script alternative for containerized deployments.

## Operational Impact

1. **New base path:** Update any downstream automation that previously called `/api/v1/control/*`. All endpoints are now anchored at `/control/api/*` (for example: `/control/api/operations/database-backups`). Requests that still target the old prefix will return 404.
2. **Consistent frontend calls:** Because every component uses `CONTROL_API_BASE`, pointing the Control Panel at a different backend (or reverse proxy) is now a single constant change. If you override the base in `frontend/src/api/api.js`, verify the value propagates through the build output.
3. **Restart guardrails:** When the application runs inside the fullstack Docker container, the restart button explains why restart is blocked and points operators to `SMS.ps1 -Stop` on the host. Native deployments continue to function normally once the shutdown token is configured.

## Upgrade Checklist

1. **Rebuild artifacts**
   - `pwsh -NoProfile -File SMART_SETUP.ps1 -Force` (Docker) or `scripts/dev/run-native.ps1` (native) to pull the new frontend bundle with the Control API helper.
   - `npm --prefix frontend run build` if you package the frontend separately.
2. **Verify Control API reachability**
   - Hit `http(s)://<host>/control/api/operations/status` (or any status endpoint) and confirm a 200 response.
   - Exercise backup download/upload, restart, and log streaming flows from the Control Panel to ensure the shared base URL is respected.
3. **Confirm restart copy**
   - Trigger the restart button in both Docker and native modes to validate the new explanatory hints.
4. **Run the regression suites**
   - Backend: `cd backend; pytest -q`
   - Frontend API layer: `npm --prefix frontend run -s test -- --run src/api/__tests__/api.request.interceptor.test.ts src/api/__tests__/api.client.test.ts`
   - Frontend bundle: `npm --prefix frontend run build`
5. **Tag & publish**
   - `gh release create v1.6.5 --title "v1.6.5 – Canonical Control API" --notes-file docs/releases/v1.6.5.md`
   - Attach any deployment artifacts required by the RUN/SMART_SETUP workflows.

## Troubleshooting

- **Control API returns 404** – Confirm your reverse proxy exposes `/control/*` to FastAPI and nothing is rewriting it back under `/api/v1`. If you customized the frontend base URL, search for stray hardcoded strings and replace them with `CONTROL_API_BASE`.
- **Restart button stays disabled** – Ensure `CONTROL_ALLOW_SHUTDOWN_TOKEN` and `CONTROL_SHUTDOWN_TOKEN` are set when running natively. Inside Docker, use `SMS.ps1 -Stop` (or `RUN.ps1 -Stop`) on the host to gracefully terminate the container instead of relying on in-container restarts.
- **Frontend still referencing old paths** – Clear `frontend/node_modules`, rerun `npm install`, and build again to pick up the `CONTROL_API_BASE` helper. Cached artifacts from prior releases can retain the deprecated paths.
