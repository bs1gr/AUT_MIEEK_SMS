services:
  backend:
    image: sms-backend:${VERSION:-latest}
    build:
      context: .
      dockerfile: docker/Dockerfile.backend
      args:
        - VERSION=${VERSION:-latest}
        - BUILD_DATE=${BUILD_DATE:-unknown}
        - VCS_REF=${VCS_REF:-unknown}
    labels:
      - "org.opencontainers.image.title=sms-backend"
      - "org.opencontainers.image.version=${VERSION:-unknown}"
    environment:
      # Database configuration (blank value = auto-detect, defaults to SQLite volume)
      - DATABASE_URL=${DATABASE_URL-}
      - DATABASE_ENGINE=${DATABASE_ENGINE:-sqlite}
      - POSTGRES_HOST=${POSTGRES_HOST:-}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_DB=${POSTGRES_DB:-}
      - POSTGRES_USER=${POSTGRES_USER:-}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-}
      - POSTGRES_SSLMODE=${POSTGRES_SSLMODE:-prefer}
      - POSTGRES_OPTIONS=${POSTGRES_OPTIONS:-}
      # Allow frontend served from compose to call backend
      - CORS_ORIGINS=http://localhost:8082
      - SMS_ENV=${SMS_ENV:-production}
      - SMS_EXECUTION_MODE=docker
      - SECRET_KEY=${SECRET_KEY:-local-dev-secret-key-20251105-change-me}
      # Authentication and admin bootstrap
      - AUTH_ENABLED=${AUTH_ENABLED:-False}
      - AUTH_MODE=${AUTH_MODE:-permissive}
      - DEFAULT_ADMIN_EMAIL=${DEFAULT_ADMIN_EMAIL:-}
      - DEFAULT_ADMIN_PASSWORD=${DEFAULT_ADMIN_PASSWORD:-}
      - DEFAULT_ADMIN_FULL_NAME=${DEFAULT_ADMIN_FULL_NAME:-}
      - DEFAULT_ADMIN_FORCE_RESET=${DEFAULT_ADMIN_FORCE_RESET:-False}
      # Enable Control API for operations panel
      - ENABLE_CONTROL_API=1
    volumes:
      - sms_data:/data
      - ./templates:/app/templates:ro  # Mount templates directory for imports
      - ./backups:/app/backups  # Ensure backups are visible on host
    expose:
      - "8000"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:8000/health/ready || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s
    # Optional: uncomment to access backend directly on host
    # ports:
    #   - "8000:8000"

  frontend:
    image: sms-frontend:${VERSION:-latest}
    build:
      context: .
      dockerfile: docker/Dockerfile.frontend
      args:
        - VITE_API_URL=/api/v1
        - VERSION=${VERSION:-latest}
        - BUILD_DATE=${BUILD_DATE:-unknown}
        - VCS_REF=${VCS_REF:-unknown}
    labels:
      - "org.opencontainers.image.title=sms-frontend"
      - "org.opencontainers.image.version=${VERSION:-unknown}"
    depends_on:
      backend:
        condition: service_healthy
    environment:
      - SMS_ENV=${SMS_ENV:-production}
      - SMS_EXECUTION_MODE=docker
    ports:
      - "8082:80"

volumes:
  sms_data:
    driver: local
