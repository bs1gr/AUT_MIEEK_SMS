services:
  backend:
    image: sms-backend:${VERSION:-latest}
    build:
      context: .
      dockerfile: docker/Dockerfile.backend
      args:
        - VERSION=${VERSION:-latest}
        - BUILD_DATE=${BUILD_DATE:-unknown}
        - VCS_REF=${VCS_REF:-unknown}
    labels:
      - "org.opencontainers.image.title=sms-backend"
      - "org.opencontainers.image.version=${VERSION:-unknown}"
    environment:
      # Persist DB to volume (explicit for Docker)
      - DATABASE_URL=sqlite:////data/student_management.db
      # Allow frontend served from compose to call backend
      - CORS_ORIGINS=http://localhost:8080
      - SMS_ENV=${SMS_ENV:-production}
      - SMS_EXECUTION_MODE=docker
      - SECRET_KEY=${SECRET_KEY:-local-dev-secret-key-20251105-change-me}
    volumes:
      - sms_data:/data
      - ./templates:/app/templates:ro  # Mount templates directory for imports
      - ./backups:/app/backups  # Ensure backups are visible on host
    expose:
      - "8000"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:8000/health/ready || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s
    # Optional: uncomment to access backend directly on host
    # ports:
    #   - "8000:8000"

  frontend:
    image: sms-frontend:${VERSION:-latest}
    build:
      context: .
      dockerfile: docker/Dockerfile.frontend
      args:
        - VITE_API_URL=/api/v1
        - VERSION=${VERSION:-latest}
        - BUILD_DATE=${BUILD_DATE:-unknown}
        - VCS_REF=${VCS_REF:-unknown}
    labels:
      - "org.opencontainers.image.title=sms-frontend"
      - "org.opencontainers.image.version=${VERSION:-unknown}"
    depends_on:
      backend:
        condition: service_healthy
    environment:
      - SMS_ENV=${SMS_ENV:-production}
      - SMS_EXECUTION_MODE=docker
    ports:
      - "8080:80"

volumes:
  sms_data:
    driver: local
